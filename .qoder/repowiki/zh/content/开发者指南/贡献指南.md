# 贡献指南

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [pyproject.toml](file://pyproject.toml)
- [Makefile](file://Makefile)
- [docs/developer/code_standard_and_dev_guide.rst](file://docs/developer/code_standard_and_dev_guide.rst)
- [qlib/log.py](file://qlib/log.py)
</cite>

## 目录
1. [简介](#简介)
2. [环境搭建](#环境搭建)
3. [分支管理与代码提交](#分支管理与代码提交)
4. [Pull Request审查流程](#pull-request审查流程)
5. [项目依赖管理](#项目依赖管理)
6. [测试覆盖率要求](#测试覆盖率要求)
7. [编码风格指南](#编码风格指南)
8. [文档同步更新](#文档同步更新)
9. [常见贡献场景实践](#常见贡献场景实践)
10. [附录](#附录)

## 简介
Qlib 是一个面向人工智能的量化投资平台，旨在通过AI技术实现量化投资研究的潜力。该项目欢迎社区贡献，包括修复bug、添加新模型、改进文档等。本指南详细说明了为Qlib项目贡献代码的完整流程和规范。

**Section sources**
- [README.md](file://README.md#L583-L634)

## 环境搭建
为确保开发环境的一致性，建议使用conda管理Python环境。Qlib支持Python 3.8至3.12版本。

### 安装步骤
1. 克隆仓库并进入目录：
```bash
git clone https://github.com/microsoft/qlib.git && cd qlib
```

2. 安装基础依赖：
```bash
pip install numpy
pip install --upgrade cython
```

3. 以可编辑模式安装Qlib：
```bash
pip install -e .
```

4. 安装开发依赖（推荐）：
```bash
pip install -e .[dev]
```

对于macOS M1用户，需先安装OpenMP：
```bash
brew install libomp
```

**Section sources**
- [README.md](file://README.md#L120-L150)
- [Makefile](file://Makefile#L130-L135)

## 分支管理与代码提交
Qlib采用标准的Git分支管理流程：

1. 从main分支创建功能分支：
```bash
git checkout -b feature/your-feature-name
```

2. 在功能分支上进行开发和提交。

3. 提交前确保代码格式化：
```bash
python -m black . -l 120
```

4. 推送分支到远程仓库：
```bash
git push origin feature/your-feature-name
```

5. 在GitHub上创建Pull Request。

**Section sources**
- [Makefile](file://Makefile#L160-L165)

## Pull Request审查流程
提交Pull Request后，系统将自动执行以下审查流程：

1. **CLA验证**：贡献者许可协议（CLA）机器人会自动检查是否需要签署CLA。只需按照机器人提供的说明操作即可。

2. **持续集成检查**：系统会自动运行CI测试，包括代码格式、风格检查和单元测试。

3. **代码审查**：项目维护者将对代码进行审查，可能提出修改建议。

4. **合并**：通过所有检查并获得批准后，PR将被合并到main分支。

**Section sources**
- [README.md](file://README.md#L627-L634)

## 项目依赖管理
Qlib使用pyproject.toml进行依赖管理，遵循现代Python包管理标准。

### 依赖分类
- **核心依赖**：在pyproject.toml的dependencies字段中定义
- **可选依赖**：在optional-dependencies字段中按功能分组

### 安装可选依赖
```bash
# 开发依赖
pip install -e .[dev]

# 测试依赖
pip install -e .[test]

# 文档依赖
pip install -e .[docs]

# 强化学习依赖
pip install -e .[rl]
```

**Section sources**
- [pyproject.toml](file://pyproject.toml#L1-L120)

## 测试覆盖率要求
Qlib要求所有新代码都应有相应的测试覆盖。

### 测试目录结构
- `tests/backtest/`：回测模块测试
- `tests/data_mid_layer_tests/`：数据中间层测试
- `tests/dataset_tests/`：数据集测试
- `tests/dependency_tests/`：依赖项测试
- `tests/misc/`：杂项测试
- `tests/model/`：模型测试
- `tests/ops/`：操作符测试
- `tests/rl/`：强化学习测试

### 运行测试
```bash
# 运行所有测试
pytest

# 运行特定模块测试
pytest tests/model/
```

**Section sources**
- [tests](file://tests)
- [Makefile](file://Makefile#L140-L145)

## 编码风格指南
遵循统一的编码风格确保代码的可读性和一致性。

### 代码格式
- 使用black进行代码格式化，行长度限制为120字符
- 执行命令：`python -m black . -l 120`

### 代码风格检查
- 使用pylint进行静态分析
- 使用flake8进行风格检查
- 忽略的错误码：E501, F541, E402, W503, E731, E203

### 文档字符串
- 采用Numpydoc风格
- 函数和类必须包含文档字符串

### 日志使用
- 使用`qlib.log`模块获取日志记录器
- 按模块组织日志
- 支持全局日志级别设置

### 异常处理
- 使用标准异常类型
- 提供清晰的错误信息
- 避免捕获过于宽泛的异常

**Section sources**
- [docs/developer/code_standard_and_dev_guide.rst](file://docs/developer/code_standard_and_dev_guide.rst#L0-L62)
- [qlib/log.py](file://qlib/log.py#L0-L47)

## 文档同步更新
当修改代码功能时，必须同步更新相关文档。

### 文档位置
- API文档：源代码中的docstring
- 用户指南：docs/目录下的.rst文件
- 示例代码：examples/目录

### 更新要求
- 新功能必须提供使用示例
- API变更必须更新文档字符串
- 重大变更需在CHANGES.rst中记录

**Section sources**
- [README.md](file://README.md#L583-L607)

## 常见贡献场景实践
### 新增模型
1. 在`qlib/contrib/model/`目录下创建新模型文件
2. 实现模型类，继承基类
3. 在examples/benchmarks/添加配置文件和示例
4. 添加单元测试
5. 更新文档和README

### 修复bug
1. 在issues中确认bug
2. 创建修复分支
3. 编写复现bug的测试用例
4. 修复代码
5. 确保所有测试通过

### 性能优化
1. 使用性能分析工具定位瓶颈
2. 提出优化方案
3. 实现优化并提供性能对比数据
4. 确保功能正确性

**Section sources**
- [README.md](file://README.md#L608-L625)

## 附录
### 开发工具命令
```bash
# 代码格式检查
make black

# 代码风格检查
make pylint

# 所有检查
make lint

# 构建包
make build

# 生成文档
make docs-gen
```

### 联系方式
- 问题反馈：[GitHub Issues](https://github.com/microsoft/qlib/issues/new/choose)
- 即时讨论：[Gitter](https://gitter.im/Microsoft/qlib)
- 邮件联系：[qlib@microsoft.com](mailto:qlib@microsoft.com)